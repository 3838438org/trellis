{% from 'render_vars.j2' import custom_vars, default_var with context -%}

# Documentation: https://roots.io/trellis/docs/vault/
{{ default_var('vault_mysql_root_password', vault_vars[item.env], vault_passwords_length) }}
{% if item.env != 'development' %}

# Documentation: https://roots.io/trellis/docs/security/
vault_users:
{% for user_name in vault_user_list -%}
{% set user = (user_name in vault_vars[item.env].vault_users | default([]) | map(attribute='name') | list) |
    ternary(vault_vars[item.env].vault_users | default([]) | selectattr('name', 'equalto', user_name) | list | first, {}) %}
  - name: "{{ user_name }}"
    {{ default_var('password', user, vault_passwords_length) }}
    {{ default_var('salt', user, 16) }}
    {{- custom_vars(user.keys() | difference(vault_user_vars), user, 4) }}
{% endfor %}
{%- endif %}

# Variables to accompany `group_vars/production/wordpress_sites.yml`
# Note: the site name (`example.com`) must match up with the site name in the above file.
vault_wordpress_sites:
{% for key in vault_site_list %}
{% if vault_wordpress_sites is defined and key in vault_wordpress_sites.keys() %}
{% set site = vault_vars[item.env].vault_wordpress_sites[key] %}
{% else %}
{% set site = {'env':{}} %}
{% endif %}
{% if not loop.first %}

{% endif %}
  {{ key }}:
    {% if item.env == 'development' -%}
    {{ default_var('admin_password', site, vault_passwords_length) }}
    {% endif -%}
    env:
      {{ default_var('db_password', site.env, vault_passwords_length) }}
{% if item.env != 'development' %}
      # Generate your keys here: https://roots.io/salts.html
{% for var in vault_site_env_salts_keys %}
{% if not loop.first %}

{% endif %}
      {{ default_var(var, site.env, 66) }}
{%- endfor %}
{% endif %}
      {{- custom_vars(site.env.keys() | difference(vault_site_env_vars), site.env, 6) -}}
    {{- custom_vars(site.keys() | difference(vault_site_vars), site, 4) -}}
{% endfor %}

{{ custom_vars(vault_vars[item.env].keys() | difference(vault_vars_default[item.env]), vault_vars[item.env], 0, true) -}}
