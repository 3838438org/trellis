---
- block:
  - name: Add vault_password_file setting to ansible.cfg
    ini_file:
      dest: ansible.cfg
      section: defaults
      option: vault_password_file
      value: "{{ vault_password_file }}"
    when:
      - vault_password_file_enabled
      - not vault_ask_pass
      - vault_password_value is defined

  - name: Add {{ vault_password_file }} to .gitignore
    lineinfile:
      dest: "{{ item }}"
      line: "{{ vault_password_file }}"
      insertbefore: BOF
    with_lines: find . .. -maxdepth 1 -type f -name .gitignore
    when: vault_password_file_enabled | bool and not vault_ask_pass and vault_password_file_gitignore

  - name: Set file mode for {{ vault_password_file }}
    file:
      path: "{{ vault_password_file }}"
      mode: "{{ vault_password_file_mode }}"
    when: vault_password_file_enabled | bool and not vault_ask_pass

  when: vault_files_state == 'encrypted'

- name: Add {{ vault_backups_path }} to .gitignore
  lineinfile:
    dest: "{{ item }}"
    line: "{{ vault_backups_path }}"
    insertbefore: BOF
  with_lines: find . .. -maxdepth 1 -type f -name .gitignore
  when: vault_file_backups and vault_backups_path_gitignore
